<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datama 1 E-commerce</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script> 
</head>
<body>
    <div id="products"></div>
    <div id="cart">
        <h2>Cart</h2>
        <ul id="cart-items"></ul>
        <p>Total: $<span id="cart-total">0</span></p>
        <button id="checkout">Simulate Checkout</button>
    </div>

    <div id="payment-form" style="display: none;"></div> 

    <script>
        const products = [
            { id: 1, name: "DICE TEE PIGMENT DYED ( Black)", price: 45, imageUrl: "https://www.stussy.com/cdn/shop/files/1905077_BLAC_2.jpg?v=1739819686&width=480" },
            { id: 2, name: "DICE TEE PIGMENT DYED ( Natural)", price: 45, imageUrl: "https://www.stussy.com/cdn/shop/files/1905077_NATL_2_d124fbbe-4c1a-4160-b36f-40e6229b83f2.jpg?v=1739819682&width=480" },
            { id: 3, name: "DICE TTEE PIGMENT DYED ( Navy)", price: 45, imageUrl: "https://www.stussy.com/cdn/shop/files/1905077_GRPE_2_17cd6dcc-4f0e-49df-87ef-1f620fe001ab.jpg?v=1739819668&width=480" },
            { id: 4, name: "DICE TEE PIGMENT DYED ( Yellow)", price: 45, imageUrl: "https://www.stussy.com/cdn/shop/files/1905077_YELO_2.jpg?v=1739819673&width=480" },
            { id: 5, name: "DICE TEE PIGMENT DYED ( Grap)", price: 45, imageUrl: "https://www.stussy.com/cdn/shop/files/1905077_NAVY_2_0c2ba580-5925-44de-bdf0-8805ea07fc0e.jpg?v=1739819678&width=480" }
        ];

        const productsDiv = document.getElementById("products");

        products.forEach(product => {
            const productDiv = document.createElement("div");
            productDiv.classList.add("product");
            productDiv.innerHTML = `
                <img src="${product.imageUrl}" alt="${product.name}" width="150">
                <h3>${product.name}</h3>
                <p>$${product.price}</p>
                <button onclick="addToCart(${product.id})">Add to Cart</button>
            `;
            productsDiv.appendChild(productDiv);
        });

        let cart = []; // Corrected line

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                cart.push(product);
                updateCartDisplay();
            }
        }

        function updateCartDisplay() {
            const cartItemsList = document.getElementById("cart-items");
            const cartTotalSpan = document.getElementById("cart-total");
            cartItemsList.innerHTML = "";
            let total = 0;

            cart.forEach(item => {
                const li = document.createElement("li"); // Corrected line
                li.textContent = `${item.name} - $${item.price}`;
                cartItemsList.appendChild(li);
                total += item.price;
            });

            cartTotalSpan.textContent = total;
        }

        const checkoutButton = document.getElementById("checkout");
        checkoutButton.addEventListener("click", simulateCheckout);

        async function simulateCheckout() {
            try {
                // Removed supabaseKey from here

                const orderData = cart.map(item => ({
                    productid: item.id,
                    productname: item.name,
                    price: item.price
                }));

                // Call the server-side function to create a checkout session
                const response = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: cart }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error creating checkout session:", errorData);
                    alert("Checkout failed.");
                    return;
                }

                const { url } = await response.json();
                window.location.href = url; // Redirect to Stripe Checkout
            } catch (error) {
                console.error("Error in simulateCheckout:", error);
                alert("Checkout failed due to an unexpected error.");
            }
        }
    </script>
</body>
</html>